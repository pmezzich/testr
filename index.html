<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MezzAI Demo ‚Äî Backend Connected (Render)</title>
  <style>
    :root { --bg:#0b1220; --card:#121b2e; --muted:#9bb0d3; --text:#e8f0ff; --accent:#4da3ff; }
    html, body { height:100%; margin:0; font-family:ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--text); }
    .wrap { max-width:1100px; margin:0 auto; padding:24px; }
    h1 { margin:0 0 6px; }
    .muted { color: var(--muted); font-size: 0.95rem; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .card { background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:16px; padding:16px; box-shadow:0 4px 24px rgba(0,0,0,.2); }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input[type="text"], textarea { width:100%; background:#0b1426; color:var(--text); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px; outline:none; }
    textarea { min-height:120px; resize:vertical; }
    button { background:var(--accent); color:#00122a; border:0; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; }
    button.secondary { background:#223356; color: var(--text); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    pre { white-space:pre-wrap; word-wrap:break-word; background:#0b1426; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.08); }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; background:#152038; color:#cfe1ff; font-size:.8rem; }
    .small { font-size:.9rem; }
    .ok { color:#86efac; }
    .err { color:#fca5a5; }
    .footer { margin-top:18px; color:#8ea7ce; font-size:.85rem; }
    @media (max-width: 1100px){ .grid { grid-template-columns: 1fr; } }
    .health { display:inline-flex; align-items:center; gap:8px; }
    .dot { width:10px; height:10px; border-radius:50%; background:#fca5a5; }
    .dot.ok { background:#86efac; }
    /* Pie filters + fade */
    .fade-section{opacity:1;transition:opacity .28s ease, transform .28s ease;transform:translateY(0)}
    .fade-section.hidden{opacity:0;transform:translateY(-6px);pointer-events:none}
    .filters .chip{background:#122447;color:#cfe1ff;border:1px solid rgba(255,255,255,.08);padding:8px 12px;border-radius:999px;cursor:pointer;font-weight:600}
    .filters .chip.active{background:var(--accent);color:#00122a}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>MezzAI ‚Äî Backend Connected</h1>
    <div class="muted">
      This page calls your <strong>Render backend</strong> for GPT/classification/email.
      Backend URL: <span id="beUrl" class="mono"></span>
    </div>
    <div class="footer health">
      <span id="healthDot" class="dot"></span>
      <span id="healthMsg" class="mono small">checking backend‚Ä¶</span>
    </div>

    <!-- GPT + Email -->
    <div class="grid" style="margin-top:16px">
      <div class="card">
        <strong>ü§ñ GPT Playground</strong>
        <p class="small muted">Routes to backend (no API key in browser).</p>
        <textarea id="gptPrompt" placeholder="Type a prompt‚Ä¶"></textarea>
        <div class="row" style="margin-top:10px">
          <button id="btnRunGPT">Run GPT</button>
        </div>
        <div id="gptOut" class="footer mono"></div>
      </div>

      <div class="card">
        <strong>‚úâÔ∏è Email Draft</strong>
        <p class="small muted">Paste an email. Backend returns a concise reply.</p>
        <textarea id="emailBody" placeholder="Paste email text here‚Ä¶"></textarea>
        <div class="row" style="margin-top:10px">
          <button id="btnEmailDraft">Generate Reply</button>
        </div>
        <div id="emailOut" class="footer mono"></div>
      </div>
    </div>

    <!-- Lead Classifier + Metrics -->
    <div class="grid" style="margin-top:16px">
      <div class="card">
        <strong>üóÇÔ∏è Lead Classifier</strong>
        <p class="small muted">Enter messages separated by <code>---</code>. Returns JSON from backend.</p>
        <textarea id="leadText" placeholder="Acme asking for a demo on Tuesday --- My PTO request for Thursday --- Cannot login to dashboard"></textarea>
        <div class="row" style="margin-top:10px">
          <button id="btnClassify">Classify</button>
        </div>
        <pre id="leadOut"></pre>
      </div>

      <div class="card">
        <strong>üìà KPI Metrics</strong>
        <p class="small muted">Calls backend endpoints <code>/api/metrics/seed</code> and <code>/api/metrics/peek</code> (fallback to Firebase demo if backend not present).</p>
        <div class="row">
          <button id="btnSeed">Seed Demo Metrics</button>
          <button id="btnPeek" class="secondary">Peek Latest</button>
        </div>
        <pre id="metricsOut"></pre>
      </div>
    </div>

    <!-- Pie Dashboard -->
    <div class="card" style="margin-top:16px">
      <strong>üìä Live Pie Dashboard</strong>
      <p class="small muted">Switch datasets and filters; smooth fade and chart transitions. Uses backend <code>/api/metrics/pie</code> if present.</p>

      <!-- Dataset Switcher -->
      <div class="row filters" id="datasetFilters" style="margin:6px 0 10px">
        <button class="chip active" data-dataset="leads">Leads by Source</button>
        <button class="chip" data-dataset="tickets">Support Tickets</button>
        <button class="chip" data-dataset="outcomes">Response Outcomes</button>
      </div>

      <!-- Time Window -->
      <div class="row filters" id="timeFilters" style="margin:6px 0 10px">
        <button class="chip active" data-period="today">Today</button>
        <button class="chip" data-period="week">This Week</button>
        <button class="chip" data-period="month">This Month</button>
      </div>

      <!-- Segments (fade section) -->
      <div class="fade-section" id="segmentSection" style="margin:6px 0 10px">
        <div class="small muted" style="margin-bottom:6px">Segments</div>
        <div class="row filters" id="segmentFilters">
          <button class="chip active" data-seg="all">All</button>
          <button class="chip" data-seg="members">Members</button>
          <button class="chip" data-seg="nonmembers">Non-Members</button>
        </div>
      </div>

      <!-- Current selection + value list -->
      <div class="row" style="justify-content:space-between; align-items:flex-end;">
        <div><div class="small muted" id="pieTitle">Leads by Source ‚Äî Today (All)</div></div>
        <div class="small muted" id="pieTotal">Total: ‚Äì</div>
      </div>

      <canvas id="pieChart" style="margin-top:12px; width:100%; height:340px;"></canvas>
      <div id="pieLegend" class="mono small" style="margin-top:10px"></div>

      <div class="footer small">
        Tip: Add your own datasets in the backend. Frontend will discover them via
        <code>/api/metrics/pie?type=‚Ä¶&period=‚Ä¶&segment=‚Ä¶</code>.
      </div>
    </div>

    <!-- Mini Chat -->
    <div class="card" style="margin-top:16px">
      <strong>üí¨ Mini Chat</strong>
      <p class="small muted">Single-turn chat via backend.</p>
      <div class="row">
        <input id="chatInput" type="text" placeholder="Ask something‚Ä¶" />
        <button id="btnChat">Send</button>
      </div>
      <div id="chatLog" class="footer"></div>
    </div>

    <div class="footer">
      ‚ö†Ô∏è If you see CORS errors, enable CORS on the backend for this origin.
    </div>
  </div>

  <!-- Firebase Client SDK (compat) for fallback only -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
  // ====== BACKEND BASE URL ======
  const BACKEND_URL = (window.MEZZAI_BACKEND_URL || "https://mezzai-backend.onrender.com").replace(/\/$/, "");
  document.getElementById("beUrl").textContent = BACKEND_URL;

  // ====== OPTIONAL FIREBASE FALLBACK (used only if backend metrics endpoints missing) ======
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyCs8BOeV5LVA60qjkAK0BMn_vxq-TzlLXM",
    authDomain: "mezzai.firebaseapp.com",
    databaseURL: "https://mezzai-default-rtdb.firebaseio.com",
    projectId: "mezzai",
    storageBucket: "mezzai.firebasestorage.app",
    messagingSenderId: "889134910925",
    appId: "1:889134910925:web:88c3568f22d64725378884",
    measurementId: "G-XQF3EFBM8S"
  };
  let DB = null;
  try {
    if (window.firebase) {
      if (!firebase.apps || firebase.apps.length === 0) {
        firebase.initializeApp(FIREBASE_CONFIG);
      }
      DB = firebase.database();
    }
  } catch (e) {
    // ignored
  }

  // ====== Endpoint map (we'll try in order until one works) ======
  const EP = {
    health: ["/api/health", "/health", "/.well-known/health"],
    chat: ["/api/chat", "/chat", "/v1/chat"],
    emailDraft: ["/api/email-draft", "/email-draft", "/v1/email"],
    classify: ["/api/classify", "/classify", "/v1/classify"],
    metricsSeed: ["/api/metrics/seed", "/metrics/seed"],
    metricsPeek: ["/api/metrics/peek", "/metrics/peek"],
    pie: ["/api/metrics/pie", "/api/pie", "/pie"]
  };

  async function callFirst(paths, init){
    let lastErr;
    for (const p of paths){
      try {
        const res = await fetch(BACKEND_URL + p, init);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const ct = res.headers.get('content-type') || '';
        if (ct.includes('application/json')) return await res.json();
        return await res.text();
      } catch(e){ lastErr = e; }
    }
    throw lastErr || new Error("All endpoints failed");
  }

  // === Backend helpers ===
  async function beChat(prompt){
    const body = JSON.stringify({ prompt });
    const data = await callFirst(EP.chat, { method:"POST", headers:{"Content-Type":"application/json"}, body });
    if (typeof data === 'string') return data;
    return data.text || data.output || JSON.stringify(data);
  }

  async function beEmailDraft(email){
    const body = JSON.stringify({ email });
    const data = await callFirst(EP.emailDraft, { method:"POST", headers:{"Content-Type":"application/json"}, body });
    if (typeof data === 'string') return data;
    return data.text || data.output || JSON.stringify(data);
  }

  async function beClassify(text){
    const body = JSON.stringify({ text });
    const data = await callFirst(EP.classify, { method:"POST", headers:{"Content-Type":"application/json"}, body });
    return data; // expect JSON
  }

  async function beMetricsSeed(){
    try { return await callFirst(EP.metricsSeed, { method:"POST" }); }
    catch(e){
      if (!DB) throw e; // fallback requires Firebase
      const ref = DB.ref("metrics/demo");
      const payload = { at:Date.now(), opensToday:rand(40,240), leadsThisWeek:rand(5,35), proposals:rand(1,16) };
      await ref.set(payload); return payload;
    }
  }
  async function beMetricsPeek(){
    try { return await callFirst(EP.metricsPeek, { method:"GET" }); }
    catch(e){
      if (!DB) throw e;
      const snap = await DB.ref("metrics/demo").get();
      return snap.val();
    }
  }

  function rand(min,max){ return Math.floor(Math.random()*(max-min)+min); }

  // === Pie Dashboard ===
  const PIE_PALETTES = {
    leads: ["Inbound","Outbound","Referral","Partner","Events"],
    tickets: ["Bug","How-to","Feature","Billing","Other"],
    outcomes: ["Resolved","Escalated","Pending","Closed-No-Action"]
  };

  function ensureArray(v){ return Array.isArray(v) ? v : []; }

  async function bePie(type, period, segment){
    const urlParams = new URLSearchParams({ type, period, segment });
    try {
      const data = await callFirst(EP.pie.map(p=>`${p}?${urlParams.toString()}`), { method:"GET" });
      return data; // expect { labels:[], values:[], total }
    } catch(e){
      const labels = PIE_PALETTES[type] || ["A","B","C","D"];
      const values = labels.map(()=>Math.floor(10 + Math.random()*90));
      const total = values.reduce((a,b)=>a+b,0);
      return { labels, values, total };
    }
  }

  let pieChart;
  function renderPie(labels, values){
    const ctx = document.getElementById("pieChart").getContext("2d");
    if (!pieChart){
      pieChart = new Chart(ctx, {
        type: "doughnut",
        data: { labels, datasets: [{ data: values }] },
        options: { responsive:true, animation:{ animateRotate:true, animateScale:true }, plugins:{ legend:{ display:true } } }
      });
    } else {
      pieChart.data.labels = labels;
      pieChart.data.datasets[0].data = values;
      pieChart.update();
    }
  }

  function setActive(btn, group){
    [...group.querySelectorAll('.chip')].forEach(b=>b.classList.toggle('active', b===btn));
  }

  function fadeSection(el, show){ el.classList.toggle('hidden', !show); }

  function writeLegend(labels, values){
    const total = values.reduce((a,b)=>a+b,0) || 1;
    const rows = labels.map((l,i)=>`${l}: ${values[i]} (${(100*values[i]/total).toFixed(1)}%)`);
    document.getElementById('pieLegend').textContent = rows.join('  |  ');
    document.getElementById('pieTotal').textContent = `Total: ${total}`;
  }

  async function refreshPie(){
    const dsBtn = document.querySelector('#datasetFilters .chip.active');
    const tmBtn = document.querySelector('#timeFilters .chip.active');
    const sgBtn = document.querySelector('#segmentFilters .chip.active');
    const type = dsBtn?.dataset.dataset || 'leads';
    const period = tmBtn?.dataset.period || 'today';
    const segment = sgBtn?.dataset.seg || 'all';

    const data = await bePie(type, period, segment);
    const labels = ensureArray(data.labels).length ? data.labels : (PIE_PALETTES[type] || []);
    const values = ensureArray(data.values).length ? data.values : new Array(labels.length).fill(1);
    renderPie(labels, values);
    writeLegend(labels, values);

    const title = `${type==='leads'?'Leads by Source': type==='tickets'?'Support Tickets':'Response Outcomes'} ‚Äî ${period[0].toUpperCase()+period.slice(1)} (${segment.replace('-', ' ')})`;
    document.getElementById('pieTitle').textContent = title;
  }

  function wirePieUI(){
    const ds = document.getElementById('datasetFilters');
    const tm = document.getElementById('timeFilters');
    const sg = document.getElementById('segmentFilters');

    ds.addEventListener('click', (e)=>{
      if(e.target.matches('.chip')){
        setActive(e.target, ds);
        fadeSection(document.getElementById('segmentSection'), e.target.dataset.dataset!=='tickets');
        refreshPie();
      }
    });
    tm.addEventListener('click', (e)=>{
      if(e.target.matches('.chip')){ setActive(e.target, tm); refreshPie(); }
    });
    sg.addEventListener('click', (e)=>{
      if(e.target.matches('.chip')){ setActive(e.target, sg); refreshPie(); }
    });
  }

  function startPieLoop(){ setInterval(refreshPie, 5000); }

  // === Health check ===
  async function healthCheck(){
    const dot = document.getElementById('healthDot');
    const msg = document.getElementById('healthMsg');
    try {
      const data = await callFirst(EP.health, { method:"GET" });
      dot.classList.add('ok');
      msg.textContent = typeof data === 'string' ? data : (data.message || 'OK');
    } catch(e){
      dot.classList.remove('ok');
      msg.textContent = `backend not reachable (${e.message})`;
    }
  }

  // === UI wiring ===
  window.addEventListener("DOMContentLoaded", async () => {
    healthCheck();
    wirePieUI();
    await refreshPie();
    startPieLoop();

    // GPT playground
    document.getElementById("btnRunGPT").addEventListener("click", async () => {
      const outEl = document.getElementById("gptOut");
      outEl.textContent = "Running via backend‚Ä¶";
      try {
        const prompt = (document.getElementById("gptPrompt").value || "Say hello in one short line.");
        const out = await beChat(prompt);
        outEl.textContent = out;
      } catch(e){ outEl.textContent = e.message; }
    });

    // Email draft
    document.getElementById("btnEmailDraft").addEventListener("click", async () => {
      const body = (document.getElementById("emailBody").value || "").trim();
      const outEl = document.getElementById("emailOut");
      if(!body){ outEl.textContent = "Paste an email first."; return; }
      outEl.textContent = "Drafting via backend‚Ä¶";
      try { const out = await beEmailDraft(body); outEl.textContent = out; }
      catch(e){ outEl.textContent = e.message; }
    });

    // Lead classifier
    document.getElementById("btnClassify").addEventListener("click", async () => {
      const txt = (document.getElementById("leadText").value || "").trim();
      const outEl = document.getElementById("leadOut");
      if(!txt){ outEl.textContent = "Type messages first."; return; }
      outEl.textContent = "Classifying via backend‚Ä¶";
      try {
        const data = await beClassify(txt);
        const pretty = (typeof data === 'string') ? data : JSON.stringify(data, null, 2);
        outEl.textContent = pretty;
      } catch(e){ outEl.textContent = e.message; }
    });

    // Metrics
    document.getElementById("btnSeed").addEventListener("click", async () => {
      const outEl = document.getElementById("metricsOut");
      outEl.textContent = "Seeding (backend or Firebase fallback)‚Ä¶";
      try { const payload = await beMetricsSeed(); outEl.textContent = "Wrote:\n" + JSON.stringify(payload, null, 2); }
      catch(e){ outEl.textContent = e.message; }
    });
    document.getElementById("btnPeek").addEventListener("click", async () => {
      const outEl = document.getElementById("metricsOut");
      outEl.textContent = "Reading (backend or Firebase fallback)‚Ä¶";
      try { const data = await beMetricsPeek(); outEl.textContent = JSON.stringify(data, null, 2) || "(empty)"; }
      catch(e){ outEl.textContent = e.message; }
    });

    // Mini chat
    document.getElementById("btnChat").addEventListener("click", async () => {
      const input = document.getElementById("chatInput");
      const msg = (input.value || "").trim(); if(!msg) return;
      const log = document.getElementById("chatLog");
      log.innerHTML += `<div><span class="pill">You</span> ${msg}</div>`;
      try { const out = await beChat(msg); log.innerHTML += `<div><span class="pill">Bot</span> ${out}</div>`; }
      catch(e){ log.innerHTML += `<div class="err mono">${e.message}</div>`; }
      input.value = "";
    });
  });
  </script>
</body>
</html>
